# ASN Registry & Events API

REST API для работы с реестром номеров карт ASN и приёма событий от терминалов.

## Установка

```bash
npm install
```

## Запуск

```bash
npm start
```

Сервер запустится на `http://localhost:3000`

## API Endpoints

### Base URL
```
http://localhost:3000/api/v1
```

### 1. Получение реестра ASN

**GET** `/registry`

Возвращает реестр номеров карт ASN с уникальным идентификатором.

**Ответ:**
```json
{
  "success": true,
  "data": {
    "registryId": "00001.2507061927",
    "asn": [
      "0107003900002300",
      "0107003900004100", 
      "0107003900015700"
    ],
    "generatedAt": "2024-01-01T12:00:00.000Z"
  },
  "meta": {
    "count": 3,
    "version": "1.0.0"
  }
}
```

### 2. Отправка пакета событий

**POST** `/events`

Принимает пакет событий от терминала.

**Тело запроса:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "tid": "TERM0001",
  "sent_at": "2024-01-01T12:00:00.000Z",
  "events": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440001",
      "timestamp": 1704110400000,
      "type": "CARD_READ",
      "data": {
        "cardNumber": "1234567890123456",
        "amount": 100.50
      }
    }
  ]
}
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "packageId": "550e8400-e29b-41d4-a716-446655440000",
    "eventsCount": 1
  },
  "meta": {
    "timestamp": "2024-01-01T12:00:00.000Z"
  }
}
```

### 3. Проверка здоровья сервера

**GET** `/health`

**Ответ:**
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T12:00:00.000Z",
  "version": "1.0.0"
}
```

## Валидация

### TID (Terminal ID)
- Строка из 8 символов
- Только латинские буквы в верхнем регистре и цифры
- Пример: `TERM0001`

### GUID
- Стандартный UUID v4
- Пример: `550e8400-e29b-41d4-a716-446655440000`

### Timestamp
- Unix timestamp в миллисекундах для событий
- ISO 8601 для дат пакетов

## Коды ошибок

| Код | Описание |
|-----|----------|
| `VALIDATION_ERROR` | Ошибка валидации входных данных |
| `DUPLICATE_PACKAGE` | Пакет с таким ID уже существует |
| `RATE_LIMIT_EXCEEDED` | Превышен лимит запросов |
| `ENDPOINT_NOT_FOUND` | Эндпоинт не найден |

## Тестирование

```bash
npm test
```

## Безопасность

- CORS включен
- Helmet для защиты заголовков
- Rate limiting (100 запросов за 15 минут)
- Валидация всех входных данных
- Логирование запросов 
