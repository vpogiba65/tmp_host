# ASN Registry & Events API Documentation

## Обзор

REST API для работы с реестром номеров карт ASN и приёма событий от терминалов. API предоставляет функциональность для генерации реестров ASN, приёма пакетов событий и административного управления данными.

## Базовый URL

```
http://localhost:3000/api/v1
```

## Аутентификация

В текущей версии API не требует аутентификации. В продакшене рекомендуется добавить JWT токены или API ключи.

## Формат ответов

Все ответы API имеют единообразную структуру:

### Успешный ответ
```json
{
  "success": true,
  "data": {
    // Данные ответа
  },
  "meta": {
    // Метаинформация
  }
}
```

### Ошибка
```json
{
  "success": false,
  "error": "Описание ошибки",
  "code": "ERROR_CODE",
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

## Коды состояния HTTP

| Код | Описание |
|-----|----------|
| 200 | Успешный запрос |
| 201 | Ресурс создан |
| 400 | Ошибка валидации |
| 404 | Ресурс не найден |
| 409 | Конфликт (дубликат) |
| 429 | Превышен лимит запросов |
| 500 | Внутренняя ошибка сервера |

## Эндпоинты

### 1. Реестр ASN

#### GET /registry

Возвращает реестр номеров карт ASN с уникальным идентификатором.

**Параметры:** Нет

**Ответ:**
```json
{
  "success": true,
  "data": {
    "registryId": "00001.2507061927",
    "asn": [
      "0107003900002300",
      "0107003900004100",
      "0107003900015700"
    ],
    "generatedAt": "2024-01-01T12:00:00.000Z"
  },
  "meta": {
    "count": 3,
    "version": "1.0.0"
  }
}
```

**Описание полей:**
- `registryId` - Уникальный идентификатор реестра в формате NNNNN.YYMMDDhhmm
- `asn` - Массив номеров карт ASN (16 цифр)
- `generatedAt` - Время генерации реестра в ISO 8601

### 2. События

#### POST /events

Принимает пакет событий от терминала.

**Тело запроса:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "tid": "TERM0001",
  "sent_at": "2024-01-01T12:00:00.000Z",
  "events": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440001",
      "timestamp": 1704110400000,
      "type": "CARD_READ",
      "data": {
        "cardNumber": "1234567890123456",
        "amount": 100.50
      }
    }
  ]
}
```

**Валидация:**
- `id` - UUID v4 (обязательно)
- `tid` - Строка 8 символов, только латинские буквы в верхнем регистре и цифры (обязательно)
- `sent_at` - ISO 8601 дата (обязательно)
- `events` - Массив событий (обязательно, минимум 1 элемент)

**Структура события:**
- `id` - UUID v4 (обязательно)
- `timestamp` - Unix timestamp в миллисекундах (обязательно)
- `type` - Строка 1-50 символов (обязательно)
- `data` - Любые JSON данные (обязательно)

**Ответ:**
```json
{
  "success": true,
  "data": {
    "packageId": "550e8400-e29b-41d4-a716-446655440000",
    "eventsCount": 1
  },
  "meta": {
    "timestamp": "2024-01-01T12:00:00.000Z"
  }
}
```

### 3. Административные эндпоинты

#### GET /admin/stats

Возвращает статистику по пакетам и событиям.

**Ответ:**
```json
{
  "success": true,
  "data": {
    "packages": 10,
    "events": 25
  }
}
```

#### GET /admin/events

Возвращает список всех пакетов событий.

**Ответ:**
```json
{
  "success": true,
  "data": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "tid": "TERM0001",
      "sent_at": "2024-01-01T12:00:00.000Z",
      "events_count": 3
    }
  ],
  "stats": {
    "packages": 10,
    "events": 25
  }
}
```

#### GET /admin/events/:id

Возвращает детали конкретного пакета событий.

**Параметры:**
- `id` - UUID пакета событий

**Ответ:**
```json
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "tid": "TERM0001",
    "sent_at": "2024-01-01T12:00:00.000Z",
    "events": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440001",
        "package_id": "550e8400-e29b-41d4-a716-446655440000",
        "timestamp": 1704110400000,
        "type": "CARD_READ",
        "data": {
          "cardNumber": "1234567890123456",
          "amount": 100.50
        }
      }
    ]
  }
}
```

#### GET /admin/asn

Возвращает текущий список ASN номеров.

**Ответ:**
```json
{
  "success": true,
  "data": [
    "0107003900002300",
    "0107003900004100",
    "0107003900015700"
  ]
}
```

#### POST /admin/asn

Обновляет список ASN номеров.

**Тело запроса:**
```json
{
  "asnList": [
    "0107003900002300",
    "0107003900004100",
    "0107003900015700"
  ]
}
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "message": "ASN list updated"
  }
}
```

### 4. Системные эндпоинты

#### GET /health

Проверка состояния сервера.

**Ответ:**
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T12:00:00.000Z",
  "version": "1.0.0"
}
```

## Коды ошибок

| Код | Описание | HTTP статус |
|-----|----------|-------------|
| `VALIDATION_ERROR` | Ошибка валидации входных данных | 400 |
| `DUPLICATE_PACKAGE` | Пакет с таким ID уже существует | 409 |
| `PACKAGE_NOT_FOUND` | Пакет событий не найден | 404 |
| `RATE_LIMIT_EXCEEDED` | Превышен лимит запросов | 429 |
| `ENDPOINT_NOT_FOUND` | Эндпоинт не найден | 404 |
| `INTERNAL_ERROR` | Внутренняя ошибка сервера | 500 |

## Примеры использования

### cURL

#### Получение реестра ASN
```bash
curl -X GET http://localhost:3000/api/v1/registry
```

#### Отправка пакета событий
```bash
curl -X POST http://localhost:3000/api/v1/events \
  -H "Content-Type: application/json" \
  -d '{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "tid": "TERM0001",
    "sent_at": "2024-01-01T12:00:00.000Z",
    "events": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440001",
        "timestamp": 1704110400000,
        "type": "CARD_READ",
        "data": {
          "cardNumber": "1234567890123456",
          "amount": 100.50
        }
      }
    ]
  }'
```

#### Получение статистики
```bash
curl -X GET http://localhost:3000/api/v1/admin/stats
```

### JavaScript (fetch)

#### Получение реестра
```javascript
const response = await fetch('http://localhost:3000/api/v1/registry');
const data = await response.json();
console.log(data.data.registryId);
```

#### Отправка событий
```javascript
const response = await fetch('http://localhost:3000/api/v1/events', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    id: '550e8400-e29b-41d4-a716-446655440000',
    tid: 'TERM0001',
    sent_at: new Date().toISOString(),
    events: [
      {
        id: '550e8400-e29b-41d4-a716-446655440001',
        timestamp: Date.now(),
        type: 'CARD_READ',
        data: { cardNumber: '1234567890123456' }
      }
    ]
  })
});
```

## Ограничения

### Rate Limiting
- 100 запросов за 15 минут на IP адрес
- При превышении лимита возвращается ошибка 429

### Размер запросов
- Максимальный размер JSON: 10MB
- Рекомендуемый размер пакета событий: до 1000 событий

### Валидация данных
- TID: ровно 8 символов, только A-Z и 0-9
- GUID: стандартный UUID v4
- ASN: ровно 16 цифр
- Timestamp: Unix timestamp в миллисекундах

## Версионирование

API использует версионирование в URL: `/api/v1/`

При выпуске новых версий будет создаваться `/api/v2/`, `/api/v3/` и т.д.

## Поддержка

Для вопросов и поддержки обращайтесь к разработчикам API.

---

**Версия документации:** 1.0.0  
**Последнее обновление:** 2024-01-01 